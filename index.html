<!DOCTYPE html>
<html>
<head>
	<title>Vue Component</title>
	<style>
		body {
			margin: 5%;
		}
		.text-danger{
			color: red;
			transition-duration: 5s;
			transition-delay: 2s;
		}
		.gambar{
			width: 200px;
			border-radius: 10px;
		}
		.form-group{
			margin-bottom: 10px;
		}
		.error{
			color: red;
		}
	</style>
</head>
<body>
	<div id="app">
		<c-header message="haloo component lagii" gambar="images/vue2.png"></c-header>

		<nav>
			<router-link to="/">Home</router-link>
			<router-link to="/about">About</router-link>
			<router-link to="/kelas">Kelas</router-link>
		</nav>
		<main>
			<!-- <c-main :child="kelas" @submitkelas="submitKelas" @hapuskelas="hapusKelas"/> -->
			<!-- <router-view :child="kelas" @submitkelas="submitKelas" @hapuskelas="hapusKelas"></router-view> -->
			<router-view :child="kelas" @em-submitkelas="submitKelasParent" @hapuskelas="hapusKelas"></router-view>
		</main>	
		<c-footer />
	</div>

	<script src="https://cdn.jsdelivr.net/npm/vue@2.6.12"></script>
	<script src="https://unpkg.com/vue-router/dist/vue-router.js"></script>
	<script src="https://unpkg.com/uuid@latest/dist/umd/uuidv4.min.js"></script>
	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

	<script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-database.js"></script>
	<script>
		var firebaseConfig = {
			apiKey: "AIzaSyDyQC41jtR6MbkeGm8UbZiGoCyvmVcXl9U",
			authDomain: "tutorial-vue-e8ac3.firebaseapp.com",
			projectId: "tutorial-vue-e8ac3",
			storageBucket: "tutorial-vue-e8ac3.appspot.com",
			messagingSenderId: "982178270147",
			appId: "1:982178270147:web:4835ea9cc9c2c70cd5cb76"
		};
		firebase.initializeApp(firebaseConfig);

		const db = firebase.database()
		const refKelas = db.ref('kelas')
	</script>
	<script>
		const Home  = { template: '<div>Ini Homee</div>' }
		const About = { template: '<div>Ini About</div>' }
		const detailKelas = {
			template: `<div>
			<img :src="detail_kelas.gambar" width="200" class="gambar"/> <br>
			<h3>{{detail_kelas.judul}} - {{$route.params.id_kelas}}</h3>
			<p>{{detail_kelas.deskripsi}}</p>
			<router-link to="/kelas">kembali</router-link>
			</div>`,
			data(){
				return {
					detail_kelas: {}
				}
			},
			created(){
				this.filterKelasById()
			},
			methods: {
				filterKelasById() {
					let id = this.$route.params.id_kelas
					let refKelasDetail = db.ref('kelas/'+id)
					refKelasDetail.on('value', (item) => {
						this.detail_kelas = item.val()
					})
				}
			}
		}
		const Notfound = { template: '<div>Ini halaman not found</div>' }
		const Kelas = {
			props: ['child'],
			template: `
			<div>
			<h5>Tambah kelas dengan enter</h5>
			<form @submit.prevent="submitKelasChild">						
			<div class="form-group">
			<label>Judul</label> <br>
			<input type="text" placeholder="Judul" v-model="kelas.judul">
			<div class="error" v-if="error.judul">{{error.judul}}</div>
			</div>
			<div class="form-group">
			<label>Deskripsi</label> <br>
			<textarea v-model="kelas.deskripsi"></textarea>
			<div class="error" v-if="error.deskripsi">{{error.deskripsi}}</div>
			</div>
			<div class="form-group">
			<img :src="previewimg" v-if="previewimg" width="200"/> <br>
			<label>Gambar</label> <br>
			<input type="file" ref="gambar" @change="uploadFile">
			</div>
			<br>
			<button type="submit">Tambahkan</button>
			</form>
			<template v-if="child.length > 0">
			<ul>
			<!-- melooping data array dan memunculkannya -->
			<li v-for="(k, index) of child" style="margin-bottom: 30px;">
			<img :src="k.gambar" alt="" class="gambar" /> <br>
			{{index+1}} - {{k.judul}} - {{k.deskripsi}}
			<!-- menghapus data menggunakan parameter index/key nya -->
			<router-link :to="'/kelas/' + k.id">Lihat kelas</router-link>
			<a href="" @click.prevent="$emit('hapuskelas', k.id)">hapus</a><hr>
			</li>
			</ul>				
			</template>
			<p v-else>
			<b>Belum  ada kelas, silakan tambahkan kelas</b>
			</p>
			<p class="text-danger" style="display: none">
			Berhasil menghapus data
			</p>
			</div>
			`,
			data: function(){
				return {
					kelas: {
						judul: '',
						deskripsi: '',
						gambar: ''
					},
					error: {
						judul: '',
						deskripsi: ''
					},
					previewimg: ''
				}
			},
			methods: {
				submitKelasChild: function(){
					if (this.kelas.judul == '') {
						this.error.judul = 'Judul wajib diisi'
					}else{
						this.error.judul = ''
					}
					if(this.kelas.deskripsi == ''){
						this.error.deskripsi = 'Deskripsi wajib diisi'
					}else{
						this.error.deskripsi = ''
					}
					if (this.kelas.judul && this.kelas.deskripsi) {
						const sendData = {
							id: uuidv4(),
							judul: this.kelas.judul,
							deskripsi: this.kelas.deskripsi,
							gambar: this.previewimg
						}
						this.$emit('em-submitkelas', sendData)

						this.kelas.judul = ''
						this.kelas.deskripsi = ''
						this.kelas.gambar = ''
						this.previewimg = ''
						this.$refs.gambar.value = ''
					}					
				},
				uploadFile: function(event){
					// this.kelas.gambar = event.target.files[0].name
					this.kelas.gambar = URL.createObjectURL(event.target.files[0])
					this.previewimg   = URL.createObjectURL(event.target.files[0])
				}
			}
		}

		const routes = [
		{ path: '/', component: Home },
		{ path: '/about', component: About },
		{ path: '/kelas', component: Kelas },
		{ path: '/kelas/:id_kelas', component: detailKelas },
		{ path: '*', component: Notfound}
		]

		const router = new VueRouter({
			mode: 'history',
			routes
		})

		Vue.component('c-header', {			
			props: ['message', 'gambar'],
			template: `
			<header>
			<img style="height: 200px;border-radius: 10px;display: block;margin-bottom: 20px;" :src="gambar" alt="gambar">
			<p>ini {{message}}</p>
			</header>
			`,
			data: function(){
				return {
					pesan: 'Heloo, Component !'
				}
			}
		})

		Vue.component('c-footer', {
			template: `
			<footer id="footer">
			<p>copyright 2021</p>			
			</footer>
			`			
		})
		const vm = new Vue({
			el: '#app',
			router,
			data: {
				// kelas: [
				// {id: 1, judul: 'Ini judul PHP', deskripsi: 'Ini deskripsi PHP', gambar: 'vue.png'},
				// {id: 2, judul: 'Ini judul Javascript', deskripsi: 'Ini deskripsi Javascript', gambar: 'vue2.png'},
				// {id: 3, judul: 'Ini judul CSS', deskripsi: 'Ini deskripsi CSS', gambar: 'vue3.png'},
				// ]
				kelas: []
			},
			created(){
				refKelas.on('value', this.resultData, this.errorData)
			},
			methods: {
				hapusKelas: function(id){
					db.ref('kelas/'+id).remove()
					swal({
						title: 'Sukses',
						text: "Berhasil menghapus data kelas ",
						icon: "success"
					});
				},
				submitKelasParent: function(data){
					
					refKelas.push({
						judul: data.judul,
						deskripsi: data.deskripsi,
						gambar: data.gambar
					})
					swal("Sukses!", "Berhasil menambah data kelas", "success");
					swal({
						title: 'Sukses',
						text: "Berhasil menambah data kelas " + data.judul,
						icon: "success"
					});
				},
				resultData(items){
					this.kelas = []
					items.forEach( (item) => {
						let data = {
							id: item.key,
							judul: item.val().judul,
							deskripsi: item.val().deskripsi,
							gambar: item.val().gambar,
						}
						this.kelas.push(data)
					} )
				},
				errorData(err){
					console.log(err)
				}
			},
			computed: {

			}
		})
	</script>
</body>
</html>